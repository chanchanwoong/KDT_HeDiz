<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.config.HomeMapper">

    <!--모든 미용실 조회-->
    <select id="findAllHairshop" resultType="HairshopDTO">
        select shop_seq, shop_name, shop_address, shop_intro, shop_image, shop_start, shop_end, shop_phone, shop_regular, shop_tag,
        (select avg(review_score) from t_review as b where b.shop_seq=a.shop_seq group by shop_seq ) as avg_review_score,
        (select count(review_score) from t_review as c where c.shop_seq=a.shop_seq) as count_review
        from T_HAIRSHOP as a
    </select>

    <!--특정 미용실 조회-->
    <select id="findHairshop" resultType="HairshopDTO">
        select shop_seq, shop_name, shop_address, shop_intro, shop_image, shop_start, shop_end, shop_phone, shop_regular, shop_tag,
        (select avg(review_score) from t_review as b where b.shop_seq=a.shop_seq group by shop_seq ) as avg_review_score,
        (select count(review_score) from t_review as c where c.shop_seq=a.shop_seq) as count_review
        from T_HAIRSHOP as a
        where shop_seq=#{shop_seq}
    </select>

    <!--특정 미용실의 헤어스타일 조회-->
    <select id="findHairstyle" resultType="HairstyleDTO">
        select style_seq, style_name, style_gender, style_time, style_price, style_intro, style_image, cate_name
        from T_HAIRSTYLE inner join T_CATEGORY using(cate_seq)
        where shop_seq=#{shop_seq}
    </select>

    <!--특정 미용실의 직원 조회-->
    <select id="findStaff" resultType="StaffDTO">
        select staff_seq, staff_role, staff_image, staff_intro, staff_nickname, staff_off
        from T_STAFF
        where shop_seq=#{shop_seq}
    </select>

    <!--특정 미용실 리뷰 조회-->
    <select id="findReview" resultType="ReviewDTO">
        SELECT
        tr.review_seq,
        th.shop_name,
        cu.cust_name,
        tr.review_score,
        tr.review_content,
        tr.review_photo,
        tr.review_date,
        tr.review_reply,
        s.staff_nickname,
        st.style_name
        FROM
        t_review tr
        LEFT JOIN t_hairshop th ON tr.shop_seq = th.shop_seq
        LEFT JOIN t_reservation re ON tr.reserv_seq = re.reserv_seq
        LEFT JOIN t_customer cu ON tr.reserv_seq = cu.cust_seq
        LEFT JOIN t_staff s ON re.staff_seq = s.staff_seq
        LEFT JOIN t_hairstyle st ON re.style_seq = st.style_seq
        WHERE
        tr.shop_seq = #{shop_seq}
    </select>
    
    <!--keyword를 이용해 미용실 조회-->
    <select id="findHairshopUsingKeyword" resultType="HairshopDTO">
        SELECT shop_seq, shop_name, shop_address, shop_intro, shop_image, shop_start, shop_end, shop_phone, shop_regular, shop_tag,
        (SELECT avg(review_score) FROM t_review as b WHERE b.shop_seq=a.shop_seq group by shop_seq ) as avg_review_score,
        (SELECT count(review_score) FROM t_review as c WHERE c.shop_seq=a.shop_seq) as count_review
        FROM T_HAIRSHOP as a
        WHERE shop_name like CONCAT('%', #{keyword}, '%')
    </select>
</mapper>